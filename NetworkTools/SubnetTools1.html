<!-- @Auth: Demon-- >
<!-- @Date: 2017-5-23 -- >
<!-- @Desc: 子网划分计算工具第一版-- >
<!-- @Vers: 1.0-- >

<html>

<head>
	<meta charset="utf-8" />
	<style>
		.short{
			width: 50px;
		}
		
		.Inp{
			border: 1px solid silver;
			position: relative;
			width: 600px;
			height: 200px;
			overflow:scroll;
		}
		.tb{
			border-collapse: collapse;
			text-align: center;
		}	
		.tb td{
			width:150px;
			border: 1px solid #C0C0C0;
			
		}
	</style>
	</head>
	<body>
		<h3>子网划分</h3>
		<p>===================================================</p>
		请输入你要划分多少个网段：<input id="num" class="short"/>
		<input type="button" value="确定" onclick="createInp()"/>
		<div class="Inp" id="Inp"></div>
		<br />
		
		请输入需要被划分的子网或IP：<input id="net">/<input class="short" id="mask"/>
		
		<input type="button" onclick="calc()" value="计算"/>
		<p>运算结果为：</p>
		<div class="Inp" id="res">
			<table class="tb" id="tb">
				<tr>
					<td>网络地址</td>
					<td>子网掩码</td>
					<td>第一地址</td>
					<td>最后地址</td>
					<td>广播地址</td>
				</tr>
			</table>
		</div>
		<script>
			var arrlen;
			function createInp(){
				var num = document.getElementById("num").value;
				if(num>20){
					alert("最多支持划分20个网段!");
					return false;
				}
				var str="";
				for(i=0;i<num;i++){
					str+="第"+(i+1)+
					"个网段需要<input class='short' id='num"+i+
					"'>台主机&nbsp;&nbsp;&nbsp;&nbsp;";
					if(i%2==1)str+="<br/>";
				}
				document.getElementById("Inp").innerHTML=str;
				arrlen = num;
			}
			
			//main function 
			function calc(){
				var result;
				var network,submask,firstIP,lastIP,broadcast;
				var netarr,maskarr,hostarr,flagarr;
				var info="<tr><td>网络地址</td><td>子网掩码</td><td>第一地址</td><td>最后地址</td><td>广播地址</td></tr>";
				
				var arr =new Array();
				
				//获取输入的主机个数
				for(i=0;i<arrlen;i++){
					var zhuji_num = document.getElementById("num"+i).value;
					arr[i]=zhuji_num;
				}
				
				//转成主机位
				for(x in arr)
					arr[x] = calchostbit(arr[x]);
				
				arr.sort();
				
				netarr = initNetwork();
				if(!netarr)return false;
				netarr[3]-=1;			
				flagarr = netarr;
				
				//计算子网掩码,网络号,首尾IP，广播号
				while(arr.length){
					var com = arr.pop();
					var net = 32 - com;  //网络位
					
					//计算子网
					submask = calcmask(net);
					maskarr = submask.split(".");
					
					//计算网络
					if((flagarr[3]-0)+1>255){
						flagarr[3]=0;
						flagarr[2]=(flagarr[2]-0)+1;
					}else{
						flagarr[3]=flagarr[3]-0+1;
					}
					
					network = flagarr.join(".");
					
					//第一地址
					flagarr[3]+=1
					firstIP = flagarr.join(".");
					
					//广播地址
					for(x in maskarr)maskarr[x]=255-maskarr[x];
					for(i=0;i<4;i++){
						flagarr[i]|=maskarr[i];
					}
					broadcast = flagarr.join(".");
					
					//最后地址
					flagarr[3]-=1;
					lastIP = flagarr.join(".");
					
					//为下次循环做准备
					flagarr=broadcast.split(".");
					
					//输出信息
					info += "<tr><td>"+network+"</td><td>"+submask+"</td><td>"+firstIP+"</td><td>"+lastIP+"</td><td>"+broadcast+"</td></tr>";
				}
				
				document.getElementById("tb").innerHTML=info;
			}
			
			//主机数转成较大且靠近的2的倍数
			function calchostbit(num){
				var i=0;
				num=(num-0)+2;	//加上广播号和网络号
				while(num>1){
					num = parseInt(num/2);
					i++;
				}
				if(num==1)i++;
				return i;
			}
			
			function calcmask(num){
				var str = '';
				var integer = parseInt(num/8);
				var mod = num % 8;
				switch(integer){
					case 0:return changesub(mod)+".0.0.0";
					case 1:return "255."+changesub(mod)+".0.0";
					case 2:return "255.255."+changesub(mod)+".0";
					case 3:return "255.255.255."+changesub(mod);
					case 4:return "255.255.255.255";
				}
			}
			
			function changesub(num){
				switch(num){
					case 0:return 0;
					case 1:return 128;
					case 2:return 192;
					case 3:return 224;
					case 4:return 240;
					case 5:return 248;
					case 6:return 252;
					case 7:return 254;
				}
			}
			
			function initNetwork(){
					var netIP = document.getElementById("net").value;
					var netBit = document.getElementById("mask").value;
					
					//simple check
					var netarr = netIP.split(".");
					for(x in netarr)
					if(netarr[x]>255||netarr<0){
						alert("输入的IP有误！");
						return false;
					}
					if(netBit<0||netBit>32){
						alert("网络位不可以超过范围!")
						return false;
					}
					
					//get the submask
					var submask = calcmask(netBit);
					var maskarr = submask.split(".");
					
					//进行'与'运算
					for(i=0;i<4;i++)
						netarr[i]&=maskarr[i];
					
					return netarr;
				}
		</script>
</body>
</html>